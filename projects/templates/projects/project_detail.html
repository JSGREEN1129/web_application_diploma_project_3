{% extends 'core/base_users.html' %}
{% load static %}
{% load static widget_tweaks %}

{% block title %}Project Detail{% endblock %}

{% block content %}
<div class="container my-4">
    <h2 class="mb-4">{{ project.name }} (ID: {{ project.id }})</h2>
    {% if project.description %}
        <p id="descriptionPreview" class="description-text">
            {{ project.description|truncatechars:150|linebreaksbr }}
            {% if project.description|length > 150 %}
                ... <a id="toggleDescription" 
                       data-bs-toggle="collapse" 
                       href="#fullDescription" 
                       role="button" 
                       aria-expanded="false" 
                       aria-controls="fullDescription">
                    Expand
                </a>
            {% endif %}
        </p>

        {% if project.description|length > 150 %}
            <div class="collapse mt-2" id="fullDescription">
                <p class="description-text">{{ project.description|linebreaksbr }}</p>
            </div>
        {% endif %}
    {% endif %}

    {% if project.status == "open" %}
    <span class="badge bg-success mb-3">Open</span>
    {% elif project.status == "closed" %}
    <span class="badge bg-secondary mb-3">Closed</span>
    {% endif %}

    <div class="small text-muted mb-4">
        <p class="mb-1"><strong>Total Tasks:</strong> {{ project.total_tasks }}</p>
        <p class="mb-1">✔ Completed: {{ project.completed_count }}</p>
        <p class="mb-1">⏳ Outstanding: {{ project.outstanding_count }}</p>
        <p class="mb-1 text-danger">⚠ Overdue: {{ project.overdue_count }}</p>
    </div>

    <div class="mb-4 d-flex gap-2 flex-wrap">
        <a href="{% url 'task_create' project.id %}" class="btn btn-primary">+ Add Task</a>
        <a href="{% url 'project_detail' project.id %}?status=all"
            class="btn btn-primary {% if status_filter == 'all' %}active{% endif %}">All Tasks</a>
        <a href="{% url 'project_detail' project.id %}?status=completed"
            class="btn btn-primary {% if status_filter == 'completed' %}active{% endif %}">Completed</a>
        <a href="{% url 'project_detail' project.id %}?status=outstanding"
            class="btn btn-primary {% if status_filter == 'outstanding' %}active{% endif %}">Outstanding</a>
        <a href="{% url 'project_detail' project.id %}?status=overdue"
            class="btn btn-primary {% if status_filter == 'overdue' %}active{% endif %}">Overdue</a>
        <a href="{% url 'project_edit' project.id %}?next={% url 'project_detail' project.id %}" class="btn btn-edit">Edit Project</a>
        <!-- Delete Button triggers modal -->
          <button type="button" class="btn btn-secondary" data-bs-toggle="modal"
            data-bs-target="#deleteProjectModal{{ project.id }}">
            Delete
          </button>

          <!-- Modal -->
          <div class="modal fade" id="deleteProjectModal{{ project.id }}" tabindex="-1"
            aria-labelledby="deleteProjectModalLabel{{ project.id }}" {% if error_project_id == project.id %}
            aria-modal="true" role="dialog" {% else %} aria-hidden="true" {% endif %}>
            <div class="modal-dialog">
              <form method="POST" action="{% url 'project_confirm_delete' project.id %}">
                {% csrf_token %}
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title text-danger" id="deleteProjectModalLabel{{ project.id }}">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                    <p>To delete this project, please enter your password:</p>
                    <input type="password" name="password" class="form-control" placeholder="Enter your password"
                      required>

                    {% if error_project_id|default:'' == project.id|stringformat:"s" %}
                    <div class="alert alert-danger mt-3" role="alert">
                      Incorrect password. Project was not deleted.
                    </div>
                    {% endif %}
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Delete Project</button>
                  </div>
                </div>
              </form>
            </div>
        </div>

        <a href="{% url 'project_list' %}" class="btn btn-primary">← Back to Projects</a>
    </div>

    <h3 class="my-3">Tasks</h3>
    {% if tasks %}
    <div class="row">
        {% for task in tasks %}
        <div class="col-md-6 col-lg-4 mb-3">
            <div class="card h-100 border-primary">
                <div class="card-body">
                    <h5 class="card-title">{{ task.name|default:"Untitled Task" }}</h5>
                    <p class="card-text">{{ task.description|default:"No description"|truncatechars:100 }}</p>

                    {% if task.status == "completed" %}
                    <span class="badge bg-success">Completed</span>
                    {% elif task.status == "outstanding" %}
                    <span class="badge bg-warning">Outstanding</span>
                    {% elif task.status == "overdue" %}
                    <span class="badge bg-danger">Overdue</span>
                    {% endif %}

                    <div class="mt-3 small text-muted">
                        {% if task.start_date %}
                        <p><strong>Start Date:</strong> {{ task.start_date|date:"M d, Y" }}</p>
                        {% endif %}
                        {% if task.end_date %}
                        <p><strong>End Date:</strong> {{ task.end_date|date:"M d, Y" }}</p>
                        {% endif %}
                    </div>
                </div>

                <div class="card-footer bg-transparent border-top-0 d-flex gap-2 flex-wrap">
                    <a href="{% url 'task_detail' task.id %}" class="btn btn-sm btn-primary">View Details</a>
                    <a href="{% url 'task_edit' task.id %}" class="btn btn-sm btn-edit">Edit</a>

                    <button type="button" class="btn btn-sm btn-secondary" data-bs-toggle="modal"
                        data-bs-target="#deleteTaskModal{{ task.id }}">
                        Delete
                    </button>

                    <div class="modal fade" id="deleteTaskModal{{ task.id }}" tabindex="-1"
                        aria-labelledby="deleteTaskModalLabel{{ task.id }}" {% if error_task_id == task.id %}
                        aria-modal="true" role="dialog" {% else %} aria-hidden="true" {% endif %}>
                        <div class="modal-dialog">
                            <form method="POST" action="{% url 'task_delete' task.id %}">
                                {% csrf_token %}
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title text-danger" id="deleteTaskModalLabel{{ task.id }}">Confirm Delete
                                        </h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <p class="modal-text">To delete this task, please enter your password:</p>
                                        <input type="password" name="password" class="form-control"
                                            placeholder="Enter your password" required>

                                        {% if error_task_id|default:'' == task.id|stringformat:"s" %}
                                        <div class="alert alert-danger mt-3" role="alert">
                                            Incorrect password. Task was not deleted.
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary"
                                            data-bs-dismiss="modal">Cancel</button>
                                        <button type="submit" class="btn btn-danger">Delete Task</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                {% if task.status == 'completed' %}
                <a href="{% url 'task_toggle_complete' task.id %}"
                    class="btn btn-sm only-top-border secondary w-100 mt-4"
                    onclick="return confirm('Re-open this task?');">Re-open</a>
                {% else %}
                <a href="{% url 'task_toggle_complete' task.id %}" class="btn btn-sm only-top-border success w-100 mt-4"
                    onclick="return confirm('Mark this task as complete?');">Complete</a>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p class="text-muted">No tasks for this project yet.</p>
    {% endif %}
</div>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const errorTaskId = "{{ error_task_id|default:'' }}";
        if (errorTaskId) {
            const modal = new bootstrap.Modal(document.getElementById('deleteTaskModal' + errorTaskId));
            modal.show();
        }
    });

    document.addEventListener("DOMContentLoaded", function () {
        const toggleLink = document.getElementById("toggleDescription");
        const collapseEl = document.getElementById("fullDescription");

        const bsCollapse = new bootstrap.Collapse(collapseEl, { toggle: false });

        collapseEl.addEventListener('show.bs.collapse', function () {
            toggleLink.textContent = "Collapse";
            toggleLink.setAttribute('aria-expanded', 'true');
        });

        collapseEl.addEventListener('hide.bs.collapse', function () {
            toggleLink.textContent = "Expand";
            toggleLink.setAttribute('aria-expanded', 'false');
        });
    });
</script>

{% endblock %}