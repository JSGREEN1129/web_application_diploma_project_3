{% extends 'core/base_users.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Task Detail{% endblock %}

{% block content %}
<div class="container my-4">
  <h2 class="mb-4">{{ task.name }} (ID: {{ task.id }})</h2>

  {% if task.status == "completed" %}
  <span class="badge bg-success mb-3">Completed</span>
  {% elif task.status == "outstanding" %}
  <span class="badge bg-warning mb-3">Outstanding</span>
  {% elif task.status == "overdue" %}
  <span class="badge bg-danger mb-3">Overdue</span>
  {% endif %}

  <div class="small text-muted mb-4">
    <p class="mb-1"><strong>Created:</strong> {{ task.created_at|date:"M d, Y" }}</p>
    {% if task.due_date %}
    <p class="mb-1"><strong>Due:</strong> {{ task.due_date|date:"M d, Y" }}</p>
    {% endif %}
    {% if task.completed_at %}
    <p class="mb-1"><strong>Completed:</strong> {{ task.completed_at|date:"M d, Y" }}</p>
    {% endif %}
  </div>

  <div class="d-flex gap-2 mb-4">
    {% if task.project.owner == user %}
    <a href="{% url 'task_edit' task.id %}?next={% url 'task_detail' task.id %}" class="btn btn-edit">Edit Task</a>
    {% endif %}

    {% if task.project.owner == user %}
    <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#deleteTaskModal">
      Delete Task
    </button>
    {% endif %}

    {% if task.status == 'completed' %}
    <a href="{% url 'task_toggle_complete' task.id %}" class="btn btn-re-open"
      onclick="return confirm('Re-open this task?');">
      Reopen Task
    </a>
    {% else %}
    <a href="{% url 'task_toggle_complete' task.id %}" class="btn btn-confirm-close"
      onclick="return confirm('Mark this task as complete?');">
      Mark as Complete
    </a>
    {% endif %}

    <a href="{% url 'project_detail' task.project.id %}" class="btn btn-primary">‚Üê Back to Project</a>
  </div>

  <div class="task-description mb-4">
    <p>{{ task.description|default:"No description provided."|linebreaksbr }}</p>
  </div>
</div>

  <div class="modal fade" id="deleteProjectModal{{ project.id }}" tabindex="-1"
            aria-labelledby="deleteProjectModalLabel{{ project.id }}" {% if error_project_id == project.id %}
            aria-modal="true" role="dialog" {% else %} aria-hidden="true" {% endif %}>
            <div class="modal-dialog">
    <form method="POST" action="{% url 'task_delete' task.id %}">
      {% csrf_token %}
      <input type="hidden" name="next" value="{% url 'task_detail' task.id %}">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteTaskModalLabel">Confirm Delete</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="modal-text">To delete this task, please enter your password:</p>
          <input type="password" name="password" class="form-control" placeholder="Enter your password" required>

          {% if error_task_id == task.id|stringformat:'s' %}
          <div class="alert alert-danger mt-3" role="alert">
            Incorrect password. Task was not deleted.
          </div>
          {% endif %}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">Delete Task</button>
        </div>
      </div>
    </form>
  </div>
</div>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const errorTaskId = "{{ error_task_id|default:'' }}";
    if (errorTaskId === "{{ task.id|stringformat:'s' }}") {
      const modal = new bootstrap.Modal(document.getElementById('deleteTaskModal'));
      modal.show();
    }
  });
</script>

{% endblock %}