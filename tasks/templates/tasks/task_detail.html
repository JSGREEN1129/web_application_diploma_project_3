{% extends 'core/base_users.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Task Detail{% endblock %}

{% block content %}
<div class="container my-4">
  {# Task title and ID #}
  <h2 class="mb-4">{{ task.name }} (ID: {{ task.id }})</h2>

  {# Display task status with colored badges #}
  {% if task.status == "completed" %}
  <span class="badge bg-success mb-3">Completed</span>
  {% elif task.status == "outstanding" %}
  <span class="badge bg-warning mb-3">Outstanding</span>
  {% elif task.status == "overdue" %}
  <span class="badge bg-danger mb-3">Overdue</span>
  {% endif %}

  {# Task creation, due, and completion dates #}
  <div class="small text-muted mb-4">
    <p class="mb-1"><strong>Created:</strong> {{ task.created_at|date:"M d, Y" }}</p>
    {% if task.due_date %}
    <p class="mb-1"><strong>Due:</strong> {{ task.due_date|date:"M d, Y" }}</p>
    {% endif %}
    {% if task.completed_at %}
    <p class="mb-1"><strong>Completed:</strong> {{ task.completed_at|date:"M d, Y" }}</p>
    {% endif %}
  </div>

  {# Action buttons section #}
  <div class="d-flex gap-2 mb-4">
    {% if task.project.owner == user %}
    <a href="{% url 'task_edit' task.id %}?next={% url 'task_detail' task.id %}" class="btn btn-edit">Edit Task</a>

    {# Delete button triggers modal popup #}
    <button type="button" class="btn btn-sm btn-secondary" data-bs-toggle="modal"
      data-bs-target="#deleteTaskModal{{ task.id }}">
      Delete
    </button>
    {% endif %}

    {# Button to toggle task completion status #}
    {% if task.status == 'completed' %}
    <a href="{% url 'task_toggle_complete' task.id %}?next={% url 'task_detail' task.id %}" class="btn btn-re-open"
      onclick="return confirm('Re-open this task?');">
      Re-open Task
    </a>
    {% else %}
    <a href="{% url 'task_toggle_complete' task.id %}?next={% url 'task_detail' task.id %}"
      class="btn btn-confirm-close" onclick="return confirm('Mark this task as complete?');">
      Mark as Complete
    </a>
    {% endif %}

    {# Link to go back to the parent project detail page #}
    <a href="{% url 'project_detail' task.project.id %}" class="btn btn-primary">‚Üê Back to Project</a>
  </div>

  {# Task description, with line breaks and fallback text if empty #}
  <div class="task-description mb-4">
    <p>{{ task.description|default:"No description provided."|linebreaksbr }}</p>
  </div>
</div>

{# Delete confirmation modal popup #}
<div class="modal fade" id="deleteTaskModal{{ task.id }}" tabindex="-1"
  aria-labelledby="deleteTaskModalLabel{{ task.id }}" aria-hidden="true">
  <div class="modal-dialog">
    <form method="POST" action="{% url 'task_delete' task.id %}">
      {% csrf_token %}
      <input type="hidden" name="next" value="{% url 'task_detail' task.id %}">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title text-danger" id="deleteTaskModalLabel{{ task.id }}">Confirm Delete</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>To delete this task, please enter your password:</p>
          <input type="password" name="password" class="form-control" placeholder="Enter your password" required>

          {# Show error message if password was incorrect #}
          {% if error_task_id|stringformat:"s" == task.id|stringformat:"s" and error_message %}
          <div class="alert alert-danger mt-3" role="alert">
            {{ error_message }}
          </div>
          {% endif %}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">Delete Task</button>
        </div>
      </div>
    </form>
  </div>
</div>

{# JavaScript to auto-open modal if there was an error during deletion #}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const errorTaskId = "{{ error_task_id|default:'' }}";
    if (errorTaskId === "{{ task.id|stringformat:'s' }}") {
      const modalElement = document.getElementById('deleteTaskModal{{ task.id }}');
      if (modalElement) {
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
      }
    }
  });
</script>

{% endblock %}